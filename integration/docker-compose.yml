services:
  netbird-server:
    image: ghcr.io/netbirdio/netbird-server:pr-5291
    ports:
      - "8080:80"
      - "3478:3478/udp"
    volumes:
      - ./config.yaml:/etc/netbird/config.yaml:ro
      - netbird-data:/var/lib/netbird
    networks:
      - default
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9000"]
      interval: 5s
      timeout: 3s
      retries: 20

  netbird-setup:
    image: ubuntu:24.04
    depends_on:
      netbird-server:
        condition: service_healthy
    volumes:
      - netbird-data:/var/lib/netbird
      - ./setup.sh:/setup.sh:ro
    entrypoint: ["bash", "/setup.sh"]

  nginx:
    image: nginx:alpine
    command:
      - sh
      - -c
      - |
        apk add --no-cache openssl &&
        mkdir -p /etc/nginx/ssl &&
        openssl req -x509 -newkey rsa:2048 -keyout /etc/nginx/ssl/key.pem -out /etc/nginx/ssl/cert.pem -days 1 -nodes -subj '/CN=echo-tls.test' &&
        nginx -g 'daemon off;'
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      backend:
        ipv4_address: 172.28.0.10

  postgres:
    image: postgres:alpine
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: testdb
    networks:
      backend:
        ipv4_address: 172.28.0.11

  coredns:
    image: coredns/coredns
    volumes:
      - ./Corefile:/Corefile:ro
    networks:
      backend:
        ipv4_address: 172.28.0.12

  routing-peer:
    image: netbirdio/netbird:latest
    cap_add:
      - NET_ADMIN
      - SYS_RESOURCE
    extra_hosts:
      - "nb-server:host-gateway"
    environment:
      - NB_SETUP_KEY=${ROUTING_PEER_SETUP_KEY}
      - NB_MANAGEMENT_URL=http://netbird-server:80
    networks:
      - default
      - backend
    depends_on:
      netbird-server:
        condition: service_healthy

volumes:
  netbird-data:

networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
